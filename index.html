<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>åŠ¨æ€äºŒç»´ç ç”Ÿæˆä¸åˆ†äº«</title>
  <style>
    :root {
      --primary-color: #4a90e2;
      --bg-color: #f4f4f9;
      --card-bg: #fff;
      --text-color: #333;
      --border-radius: 12px;
      --transition: 0.3s ease;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--bg-color);
      color: var(--text-color);
      display: flex;
      justify-content: center;
      align-items: start;
      min-height: 100vh;
      padding: 40px 20px;
    }

    .container {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 500px;
      padding: 30px;
    }

    h1 {
      font-size: 24px;
      color: var(--primary-color);
      margin-bottom: 20px;
      text-align: center;
    }

    /* Tab æ ·å¼ */
    .tabs {
      display: flex;
      justify-content: space-around;
      margin-bottom: 20px;
      border-bottom: 2px solid #ddd;
    }

    .tab {
      flex: 1;
      text-align: center;
      padding: 12px 0;
      cursor: pointer;
      font-weight: bold;
      transition: var(--transition);
    }

    .tab.active {
      color: white;
      background-color: var(--primary-color);
      border-radius: 6px 6px 0 0;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* æ–‡ä»¶æ‹–æ‹½ä¸Šä¼ åŒºåŸŸ */
    .drop-zone {
      border: 2px dashed #ccc;
      border-radius: var(--border-radius);
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
    }

    .drop-zone.dragover {
      background-color: #eef7ff;
      border-color: var(--primary-color);
    }

    .drop-zone input[type="file"] {
      display: none;
    }

    .drop-zone p {
      margin: 0;
      font-size: 14px;
      color: #666;
    }

    /* æ–‡æœ¬è¾“å…¥æ¡† */
    textarea {
      width: 100%;
      height: 100px;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: var(--border-radius);
      resize: vertical;
      font-size: 14px;
      transition: var(--transition);
    }

    textarea:focus {
      border-color: var(--primary-color);
      outline: none;
    }

    /* æ‹ç…§æŒ‰é’® */
    .camera-input {
      display: flex;
      justify-content: center;
    }

    .camera-input input[type="file"] {
      display: none;
    }

    .camera-button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: var(--transition);
    }

    .camera-button:hover {
      background-color: #357abd;
    }

    /* æŒ‰é’®ç»Ÿä¸€é£æ ¼ */
    button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: var(--border-radius);
      font-size: 16px;
      cursor: pointer;
      margin-top: 20px;
      transition: var(--transition);
    }

    button:hover {
      background-color: #357abd;
    }

    /* äºŒç»´ç ç”»å¸ƒ */
    canvas {
      margin-top: 20px;
      border: 2px solid #ddd;
      border-radius: var(--border-radius);
    }

    /* åˆ†äº«é“¾æ¥åŒºåŸŸ */
    .share-link {
      margin-top: 20px;
      word-break: break-all;
      font-size: 14px;
      color: var(--primary-color);
    }

    /* é”™è¯¯æç¤º */
    .error {
      color: #e74c3c;
      margin-top: 10px;
      font-size: 14px;
    }
  </style>
</head>

<body>

  <div class="container">
    <h1>åŠ¨æ€äºŒç»´ç ç”Ÿæˆä¸åˆ†äº«</h1>

    <!-- Tab åˆ‡æ¢ -->
    <div class="tabs">
      <div class="tab active" data-tab="camera">ğŸ“¸ æ‹ç…§ä¸Šä¼ </div>
      <div class="tab" data-tab="upload">ğŸ“¤ æ–‡ä»¶ä¸Šä¼ </div>
      <div class="tab" data-tab="text">ğŸ“ æ–‡æœ¬è¾“å…¥</div>
    </div>

    <!-- Tab å†…å®¹ -->
    <!-- æ‹ç…§ä¸Šä¼  -->
    <div class="tab-content active" id="camera">
      <div class="camera-input">
        <label class="camera-button">
      è°ƒç”¨æ‘„åƒå¤´
      <input type="file" id="camera-input-file" accept="image/*" capture="environment" onchange="handleCameraUpload(this.files)">
    </label>
      </div>
      <p style="margin-top: 10px; font-size: 14px; color: #666;">è¯·å¯¹å‡†äºŒç»´ç è¿›è¡Œæ‹æ‘„ï¼ˆè¯¥åŠŸèƒ½ç›®å‰å­˜åœ¨é—®é¢˜ï¼Œæ¨èä½¿ç”¨æ‰‹æœºæ‹ç…§åé€šè¿‡æ–‡ä»¶ä¸Šä¼ ï¼‰</p>
    </div>

    <div class="tab-content" id="upload">
      <div class="drop-zone" id="drop-zone">
        <p>ç‚¹å‡»æˆ–æ‹–æ”¾å›¾ç‰‡ä¸Šä¼ </p>
        <input type="file" id="file-input" accept="image/*" multiple />
      </div>
    </div>

    <div class="tab-content" id="text">
      <textarea id="qr-text" placeholder="ä¾‹å¦‚ï¼šcheckwork|id=...&siteId=...&classLessonId=..."></textarea>
      <button onclick="parseText()">è§£æå¹¶ç”ŸæˆäºŒç»´ç </button>
    </div>

    <!-- ç»“æœå±•ç¤º -->
    <canvas id="qr-canvas" width="300" height="300"></canvas>

    <!-- åˆ†äº«æŒ‰é’®å’Œé“¾æ¥ -->
    <div style="margin-top: 20px;">
      <button id="share-btn" disabled onclick="generateShareLink()">ç”Ÿæˆåˆ†äº«é“¾æ¥</button>
      <div class="share-link" id="share-link-output"></div>
    </div>

    <!-- é”™è¯¯ä¿¡æ¯ -->
    <div class="error" id="error-message"></div>
    <div id="toast"
      style="margin-top: 10px; padding: 10px; background: #333; color: #fff; border-radius: 6px; display: none;">âœ… é“¾æ¥å·²å¤åˆ¶
    </div>
  </div>

  <!-- ç¬¬ä¸‰æ–¹åº“ -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js "></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js "></script>

  <script>
    let intervalId = null;
  let currentParams = {};

  // Tab åˆ‡æ¢é€»è¾‘
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

      tab.classList.add('active');
      document.getElementById(tab.dataset.tab).classList.add('active');
    });
  });

  // å¤„ç†æ‹ç…§ä¸Šä¼ 
function handleCameraUpload(files) {
  if (files.length > 0) {
    parseQRCodeFromFile(files[0]);
  }
}

  // æ‹–æ‹½ä¸Šä¼ é€»è¾‘
  const dropZone = document.getElementById('drop-zone');
  const fileInput = document.getElementById('file-input');

  dropZone.addEventListener('dragover', e => {
    e.preventDefault();
    dropZone.classList.add('dragover');
  });

  dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('dragover');
  });

  dropZone.addEventListener('drop', e => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    if (e.dataTransfer.files.length > 0) parseQRCodeFromFile(e.dataTransfer.files[0]);
  });

  dropZone.addEventListener('click', () => fileInput.click());

  fileInput.addEventListener('change', () => {
    if (fileInput.files.length > 0) parseQRCodeFromFile(fileInput.files[0]);
  });

  // è§£ææ–‡æœ¬
  function parseText() {
    const text = document.getElementById('qr-text').value.trim();
    if (!text) return showError('è¯·è¾“å…¥æœ‰æ•ˆçš„ checkwork æ–‡æœ¬ã€‚');
    parseCheckwork(text);
  }

  // è§£æäºŒç»´ç å›¾ç‰‡
  function parseQRCodeFromFile(file) {
    // const reader = new FileReader();
    const img = new Image();
    const url = URL.createObjectURL(file);

    img.onload = function (event) {
      getOrientation(file, orientation => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

          // æ ¹æ® orientation è°ƒæ•´ç”»å¸ƒå¤§å°
          let width = img.width, height = img.height;

          if (orientation > 4 && orientation < 9) {
            width = img.height;
            height = img.width;
          }

          canvas.width = width;
          canvas.height = height;

          // æ ¹æ® orientation è®¾ç½® drawImage å‚æ•°
          switch (orientation) {
            case 2: ctx.transform(-1, 0, 0, 1, width, 0); break;
            case 3: ctx.transform(-1, 0, 0, -1, width, height); break;
            case 4: ctx.transform(1, 0, 0, -1, 0, height); break;
            case 5: ctx.transform(0, 1, 1, 0, 0, 0); break;
            case 6: ctx.transform(0, 1, -1, 0, height, 0); break;
            case 7: ctx.transform(0, -1, -1, 0, height, width); break;
            case 8: ctx.transform(0, -1, 1, 0, 0, width); break;
            default: break;
          }

          ctx.drawImage(img, 0, 0, width, height);
          URL.revokeObjectURL(url);

          const imageData = ctx.getImageData(0, 0, width, height);
          const qrCode = jsQR(imageData.data, width, height);

          if (qrCode) {
            parseCheckwork(qrCode.data);
          } else {
            showError('æ— æ³•è§£æäºŒç»´ç ï¼Œè¯·ç¡®ä¿å›¾ç‰‡æ¸…æ™°ä¸”ä¸ºæœ‰æ•ˆçš„äºŒç»´ç ã€‚');
          }
      });
        // const canvas = document.createElement('canvas');
        // const ctx = canvas.getContext('2d');
        // canvas.width = img.width;
        // canvas.height = img.height;
        // ctx.drawImage(img, 0, 0);

        // const imageData = ctx.getImageData(0, 0, img.width, img.height);
        // const qrCode = jsQR(imageData.data, img.width, img.height);

        // if (qrCode) {
        //   parseCheckwork(qrCode.data);
        // } else {
        //   showError('æ— æ³•è§£æäºŒç»´ç ï¼Œè¯·ç¡®ä¿å›¾ç‰‡æ¸…æ™°ä¸”ä¸ºæœ‰æ•ˆçš„äºŒç»´ç ã€‚');
        // }
    };
    img.src = url;
    // reader.readAsDataURL(file);
  }

  function getOrientation(file, callback) {
    const reader = new FileReader();
    reader.onload = function (e) {
      const view = new DataView(e.target.result);
      if (view.getUint16(0, false) != 0xFFD8) return callback(-2); // Not JPEG
      const length = view.byteLength;
      let offset = 2;
      while (offset < length) {
        if (view.getUint16(offset + 2, false) <= 8) return callback(-1);
        const marker = view.getUint16(offset, false);
        if (marker == 0xFFE1) {
          const exifLength = view.getUint16(offset + 2, false);
          const tiffOffset = offset + 6;
          callback(readTag(view, tiffOffset));
          return;
        } else offset += view.getUint16(offset + 2, false) + 2;
      }
      callback(-1);
    };
    reader.readAsArrayBuffer(file.slice(0, 64 * 1024)); // Read first 64KB
  }

  function readTag(view, tiffOffset) {
    const endianness = view.getUint16(tiffOffset, false) == 0x4949 ? true : false;
    const tagsOffset = view.getUint32(tiffOffset + 4, endianness);
    const tagCount = view.getUint16(tiffOffset + tagsOffset, endianness);
    for (let i = 0; i < tagCount; i++) {
      const tagOffset = tiffOffset + tagsOffset + 2 + i * 12;
      const tagId = view.getUint16(tagOffset, endianness);
      if (tagId == 0x0112) { // Orientation
        return view.getUint16(tagOffset + 8, endianness);
      }
    }
    return -1;
  }

  // æå–å‚æ•°å¹¶å¼€å§‹ç”ŸæˆäºŒç»´ç 
  function parseCheckwork(content) {
    const match = content.match(/checkwork\|id=(.*?)&siteId=(.*?)&createTime=(.*)&classLessonId=(.*?)($|&)/i);
    if (!match) return showError('æœªæ‰¾åˆ°åˆæ³•çš„ checkwork å­—ç¬¦ä¸²ã€‚');

    const [_, id, siteId, createTime, classLessonId] = match;
    currentParams = { id, siteId, classLessonId };

    document.getElementById('share-btn').disabled = false;
    startDynamicQRCodeGeneration(`checkwork|id=${id}&siteId=${siteId}&createTime=${createTime}&classLessonId=${classLessonId}`);
    clearError();
  }

  // å¼€å§‹åŠ¨æ€ç”ŸæˆäºŒç»´ç 
  function startDynamicQRCodeGeneration(baseContent) {
    // è§£æ baseContent ä¸­çš„ id, siteId, classLessonId
    const match = baseContent.match(/checkwork\|id=(.*?)&siteId=(.*?)&createTime=(.*)?&classLessonId=(.*?)($|&)/i);
    if (!match) return showError('æœªæ‰¾åˆ°åˆæ³•çš„ checkwork å­—ç¬¦ä¸²ã€‚');

    const [_, id, siteId, createTime, classLessonId] = match;
    currentParams = { id, siteId, classLessonId };

    // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
    if (intervalId) {
      clearInterval(intervalId);
    }

    // ç«‹å³ç”Ÿæˆä¸€æ¬¡
    generateDynamicQRCode();

    // æ¯éš” 3 ç§’é‡æ–°ç”Ÿæˆ
    intervalId = setInterval(() => {
      generateDynamicQRCode();
    }, 3000); // 3ç§’åˆ·æ–°ä¸€æ¬¡
  }

  // ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„äºŒç»´ç å†…å®¹å¹¶ç»˜åˆ¶åˆ° canvas
  function generateDynamicQRCode() {
    if (!currentParams) return;

    const { id, siteId, classLessonId } = currentParams;

    // è·å–å½“å‰æ—¶é—´å¹¶æ ¼å¼åŒ–ä¸º ISO æ ¼å¼ï¼ˆä¿ç•™æ¯«ç§’éƒ¨åˆ†ï¼‰
    const now = new Date();
    const currentTimeAdd8 = new Date(now.getTime() + 8 * 60 * 60 * 1000);
    const createTime = currentTimeAdd8.toISOString().replace('Z', ''); // è¾“å‡ºå¦‚ï¼š2025-02-28T14:43:33.308Z

    // æ„é€ å®Œæ•´çš„äºŒç»´ç å†…å®¹
    const content = `checkwork|id=${id}&siteId=${siteId}&createTime=${createTime}&classLessonId=${classLessonId}`;

    const canvas = document.getElementById('qr-canvas');
    QRCode.toCanvas(canvas, content, { width: 300 }, function (error) {
      if (error) {
        console.error(error);
        showError('ç”ŸæˆäºŒç»´ç å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚');
      }
    });
  }

  // ç”Ÿæˆåˆ†äº«é“¾æ¥
  function generateShareLink() {
    const { id, siteId, classLessonId } = currentParams;
    const shareUrl = `https://qrcode.linjhs.top/?id=${id}&siteId=${siteId}&classLessonId=${classLessonId}`;
    
    // æ˜¾ç¤ºé“¾æ¥
    const output = document.getElementById('share-link-output');
    output.textContent = shareUrl;

    // ä½¿ç”¨ Clipboard API å¤åˆ¶åˆ°å‰ªè´´æ¿
    navigator.clipboard.writeText(shareUrl).then(() => {
      // æç¤ºç”¨æˆ·
      showToast('âœ… é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    }).catch(err => {
      console.error('å¤åˆ¶å¤±è´¥:', err);
      showToast('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚');
    });
  }

  function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.style.display = 'block';
    setTimeout(() => {
      toast.style.display = 'none';
    }, 2000);
  }

  // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ URL å‚æ•°
  window.onload = function () {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('id') && urlParams.has('siteId') && urlParams.has('classLessonId')) {
      const content = `checkwork|id=${urlParams.get('id')}&siteId=${urlParams.get('siteId')}&createTime=linjhs&classLessonId=${urlParams.get('classLessonId')}`;
      parseCheckwork(content);
    }
  };

  // é”™è¯¯æç¤º
  function showError(msg) {
    document.getElementById('error-message').textContent = msg;
  }

  function clearError() {
    document.getElementById('error-message').textContent = '';
  }
  </script>

</body>

</html>
